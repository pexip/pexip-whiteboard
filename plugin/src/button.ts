import { config } from './config'

import type { Button, Plugin, RPCCallPayload } from '@pexip/plugin-api'
import { showCreatePanel, showErrorPanel, showNoWhiteboardPanel } from './panel'
import { getWebSocket } from './websocket'
import { getUser } from './user'
import { getPlugin } from './plugin'
import { closePopUp, getOpensPopUpParams, getPopUpLink, isSameDomain, openPopUp, popUpIdButton } from './popUp'
import { getVersion } from './infinityVersion'

const collaboardIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="-2 -2 28 28"><path fill="rgb(255, 255, 255)" d="M 4.8857728,23.734387 C 2.6855846,23.331809 0.99671784,21.795622 0.42009705,19.672426 0.29585151,19.214938 0.28304709,19.086308 0.28205511,18.285702 0.2810653,17.486943 0.29362664,17.356479 0.41451386,16.910206 0.97417885,14.844076 2.5723522,13.317602 4.6377068,12.876481 c 0.6231265,-0.133087 1.5698678,-0.140311 2.1580473,-0.01646 1.2084983,0.254463 2.0953929,0.748162 2.9472071,1.640594 0.9906098,1.03785 1.4983568,2.313 1.4999298,3.766915 0.0017,1.557206 -0.542341,2.8515 -1.660891,3.951431 -0.520657,0.51199 -1.0088298,0.838214 -1.6964682,1.133677 -0.70562,0.303189 -1.1160803,0.387173 -1.9871677,0.406592 -0.4298844,0.0096 -0.8855501,-0.0016 -1.0125908,-0.02483 z m 12.6862832,-0.0082 C 16.78855,23.6659 16.106668,23.461672 15.378512,23.069098 14.549397,22.622095 13.828654,21.955522 13.504792,21.336205 13.096174,20.55481 12.971731,19.919939 12.906848,18.285701 12.843593,16.692444 12.717048,16.106547 12.201978,15.02217 11.396938,13.327318 9.9565473,12.056382 8.1594912,11.455255 7.4071294,11.203585 6.8398414,11.125775 5.7470845,11.124368 4.4329256,11.122672 3.6958263,10.997851 2.9517945,10.651001 1.7427889,10.087392 0.72283934,8.6659599 0.40369611,7.0998975 0.27690917,6.4777428 0.26467343,5.4281506 0.37728674,4.8345004 0.64023747,3.4483381 1.4355093,2.1603749 2.5358577,1.3386405 3.0729363,0.93755278 3.9292742,0.5200035 4.5620666,0.35066357 5.0227192,0.22738888 5.1470094,0.21571844 5.9992159,0.21571844 c 0.8424462,0 0.9795779,0.0125335 1.4144869,0.1292908 1.5627316,0.41953381 2.7177092,1.29597376 3.2818592,2.49039676 0.355603,0.7528862 0.409791,1.0797477 0.421279,2.5411584 0.0076,0.976612 0.03107,1.3945817 0.09727,1.7378784 0.191034,0.9906827 0.606356,1.9976331 1.151067,2.7907668 0.320133,0.4661354 1.142886,1.3079504 1.624707,1.6623524 0.68982,0.507395 1.593614,0.921053 2.519634,1.153211 0.445842,0.111773 0.667933,0.132206 1.818933,0.167318 1.385627,0.04227 1.818943,0.101529 2.43321,0.332737 1.175926,0.442618 1.866547,1.071065 2.434995,2.215787 0.412659,0.831001 0.554749,1.396698 0.588961,2.344823 0.03764,1.043015 -0.117396,1.855722 -0.513056,2.689492 -1.045588,2.203367 -3.221016,3.445599 -5.700505,3.255152 z M 17.338822,11.099874 C 15.422658,10.738402 13.805353,9.3572251 13.146558,7.5196817 12.798703,6.5494197 12.732447,5.3812676 12.97066,4.4184633 c 0.513001,-2.073415 1.990115,-3.57138668 4.063371,-4.12074827 0.424953,-0.11260152 0.591259,-0.12934229 1.29442,-0.13029078 0.708386,-9.562e-4 0.865721,0.0146568 1.289591,0.12797648 1.307894,0.34965845 2.357309,1.03827067 3.128699,2.05300787 0.345967,0.4551105 0.770572,1.3398729 0.932939,1.9439893 0.120025,0.4465714 0.135974,0.5994546 0.139424,1.336297 0.0043,0.9211028 -0.07218,1.3510009 -0.374909,2.1070239 -0.6364,1.5893309 -2.049122,2.8365542 -3.703806,3.2699042 -0.631568,0.165403 -1.784521,0.210653 -2.401567,0.09426 z"/></svg>'
const collaboardIconHover = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="-2 -2 28 28"><path fill="rgb(17, 17, 17)" d="M 4.8857728,23.734387 C 2.6855846,23.331809 0.99671784,21.795622 0.42009705,19.672426 0.29585151,19.214938 0.28304709,19.086308 0.28205511,18.285702 0.2810653,17.486943 0.29362664,17.356479 0.41451386,16.910206 0.97417885,14.844076 2.5723522,13.317602 4.6377068,12.876481 c 0.6231265,-0.133087 1.5698678,-0.140311 2.1580473,-0.01646 1.2084983,0.254463 2.0953929,0.748162 2.9472071,1.640594 0.9906098,1.03785 1.4983568,2.313 1.4999298,3.766915 0.0017,1.557206 -0.542341,2.8515 -1.660891,3.951431 -0.520657,0.51199 -1.0088298,0.838214 -1.6964682,1.133677 -0.70562,0.303189 -1.1160803,0.387173 -1.9871677,0.406592 -0.4298844,0.0096 -0.8855501,-0.0016 -1.0125908,-0.02483 z m 12.6862832,-0.0082 C 16.78855,23.6659 16.106668,23.461672 15.378512,23.069098 14.549397,22.622095 13.828654,21.955522 13.504792,21.336205 13.096174,20.55481 12.971731,19.919939 12.906848,18.285701 12.843593,16.692444 12.717048,16.106547 12.201978,15.02217 11.396938,13.327318 9.9565473,12.056382 8.1594912,11.455255 7.4071294,11.203585 6.8398414,11.125775 5.7470845,11.124368 4.4329256,11.122672 3.6958263,10.997851 2.9517945,10.651001 1.7427889,10.087392 0.72283934,8.6659599 0.40369611,7.0998975 0.27690917,6.4777428 0.26467343,5.4281506 0.37728674,4.8345004 0.64023747,3.4483381 1.4355093,2.1603749 2.5358577,1.3386405 3.0729363,0.93755278 3.9292742,0.5200035 4.5620666,0.35066357 5.0227192,0.22738888 5.1470094,0.21571844 5.9992159,0.21571844 c 0.8424462,0 0.9795779,0.0125335 1.4144869,0.1292908 1.5627316,0.41953381 2.7177092,1.29597376 3.2818592,2.49039676 0.355603,0.7528862 0.409791,1.0797477 0.421279,2.5411584 0.0076,0.976612 0.03107,1.3945817 0.09727,1.7378784 0.191034,0.9906827 0.606356,1.9976331 1.151067,2.7907668 0.320133,0.4661354 1.142886,1.3079504 1.624707,1.6623524 0.68982,0.507395 1.593614,0.921053 2.519634,1.153211 0.445842,0.111773 0.667933,0.132206 1.818933,0.167318 1.385627,0.04227 1.818943,0.101529 2.43321,0.332737 1.175926,0.442618 1.866547,1.071065 2.434995,2.215787 0.412659,0.831001 0.554749,1.396698 0.588961,2.344823 0.03764,1.043015 -0.117396,1.855722 -0.513056,2.689492 -1.045588,2.203367 -3.221016,3.445599 -5.700505,3.255152 z M 17.338822,11.099874 C 15.422658,10.738402 13.805353,9.3572251 13.146558,7.5196817 12.798703,6.5494197 12.732447,5.3812676 12.97066,4.4184633 c 0.513001,-2.073415 1.990115,-3.57138668 4.063371,-4.12074827 0.424953,-0.11260152 0.591259,-0.12934229 1.29442,-0.13029078 0.708386,-9.562e-4 0.865721,0.0146568 1.289591,0.12797648 1.307894,0.34965845 2.357309,1.03827067 3.128699,2.05300787 0.345967,0.4551105 0.770572,1.3398729 0.932939,1.9439893 0.120025,0.4465714 0.135974,0.5994546 0.139424,1.336297 0.0043,0.9211028 -0.07218,1.3510009 -0.374909,2.1070239 -0.6364,1.5893309 -2.049122,2.8365542 -3.703806,3.2699042 -0.631568,0.165403 -1.784521,0.210653 -2.401567,0.09426 z"/></svg>'
const conceptboardIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="-25 70 300 300"><path fill="rgb(255, 255, 255)" d="M234.4 114.4H15.2C4 114.4-5 123.4-5 134.6v145.6c0 11.2 9 20.2 20.2 20.2h47.7v28.2c0 10.9 1.1 11.6 9.6 6.3l52.4-34.4h109.4c11.2 0 20.2-9 20.2-20.2V134.6c.1-11.2-9-20.2-20.1-20.2zm-30.2 113.1c-5.3 12-16.4 19.3-27.5 25.4-20 10.9-42 16.7-63.5 16.7-5.9 0-11.8-.4-17.6-1.3-11.8-1.8-50.5-10.3-55.2-43.7-2.9-20.4 2.1-38.2 14.8-52.8 14.8-17.1 47.1-35.4 93.5-35.5 1.5 0 2.8.6 3.8 1.7 1 1.2 1.4 2.8 1.1 4.4-.8 4.1-4.8 4.1-6.6 4.1h-1.8c-10.1.2-19.7 1.2-28.4 3.1-16.3 3.3-31.6 10-44.3 19.4-11.6 8.5-20.3 23.3-22.5 38.4-1.2 8.4-1 20.7 7 31.5 10.7 14.3 33.5 18.9 46.1 20.4 16.2 1.9 34.2-.9 53-8.3 14.9-5.9 31.3-13.3 38.4-27.2 6.2-12.2 6.1-29-.2-40-10.3-18.1-38.3-20.1-49.9-20.1-7 0-13.9.6-20 1.8-4.8 1-9.7 2.3-14.5 4-.8.3-1.6.7-2.5 1.1-2.4 1.1-5.1 2.4-7.5 2.1-3.6-.5-4.6-2.1-4.7-3.3-.4-3.1 4-6.5 6.4-7.5 15.4-6.1 30.5-8.8 45.2-8.2 12.5.5 53.9 4.7 60 35.1 2.9 15.1 2.1 28.2-2.6 38.7zm-33-25.6c-5.3 1.6-10.6 3.2-15.8 4.8-9.8 3-19.9 6.1-30.1 8.8-4 1.1-8.1 2.1-12.1 3.1-11.6 3-23.6 6-34.9 10.4-.6.2-1.2.4-1.8.4-2.2 0-3.9-1.6-4.4-4-.4-2.2.4-4.9 3.3-6 12.7-4.9 26.1-8.2 39-11.5 2.8-.7 5.5-1.4 8.3-2.1 10.2-2.6 20.3-5.7 30.1-8.8 5.2-1.6 10.4-3.2 15.7-4.8.5-.2 1-.2 1.5-.2 2.7 0 4.4 2.2 4.7 4.4.3 2.1-.6 4.7-3.5 5.5zm6.1 12.7c.5 2.2-.4 4.2-2.5 5.2-31.4 15.7-59.7 24.8-86.5 28.1h-.7c-2.4 0-4.2-1.8-4.4-4.3-.2-2.5 1.4-5.5 4.7-5.8 25-3 51.7-11.8 81.9-26.8 3.1-1.6 6.8.4 7.5 3.6zm-18.2-33.3c-25.8 14.1-56.1 19.5-84.9 23.9-.3 0-.6.1-.8.1-3.1 0-5.2-2.6-5.4-5.2-.2-2.5 1.4-4.3 3.8-4.7 29.5-4.4 57.9-9.5 82.2-22.8 3-1.6 6.6.2 7.4 3.4.6 2.1-.3 4.2-2.3 5.3z" /></svg>'
const conceptboardIconHover = '<svg xmlns="http://www.w3.org/2000/svg"  viewBox="-25 70 300 300"><path fill="rgb(17, 17, 17)" d="M234.4 114.4H15.2C4 114.4-5 123.4-5 134.6v145.6c0 11.2 9 20.2 20.2 20.2h47.7v28.2c0 10.9 1.1 11.6 9.6 6.3l52.4-34.4h109.4c11.2 0 20.2-9 20.2-20.2V134.6c.1-11.2-9-20.2-20.1-20.2zm-30.2 113.1c-5.3 12-16.4 19.3-27.5 25.4-20 10.9-42 16.7-63.5 16.7-5.9 0-11.8-.4-17.6-1.3-11.8-1.8-50.5-10.3-55.2-43.7-2.9-20.4 2.1-38.2 14.8-52.8 14.8-17.1 47.1-35.4 93.5-35.5 1.5 0 2.8.6 3.8 1.7 1 1.2 1.4 2.8 1.1 4.4-.8 4.1-4.8 4.1-6.6 4.1h-1.8c-10.1.2-19.7 1.2-28.4 3.1-16.3 3.3-31.6 10-44.3 19.4-11.6 8.5-20.3 23.3-22.5 38.4-1.2 8.4-1 20.7 7 31.5 10.7 14.3 33.5 18.9 46.1 20.4 16.2 1.9 34.2-.9 53-8.3 14.9-5.9 31.3-13.3 38.4-27.2 6.2-12.2 6.1-29-.2-40-10.3-18.1-38.3-20.1-49.9-20.1-7 0-13.9.6-20 1.8-4.8 1-9.7 2.3-14.5 4-.8.3-1.6.7-2.5 1.1-2.4 1.1-5.1 2.4-7.5 2.1-3.6-.5-4.6-2.1-4.7-3.3-.4-3.1 4-6.5 6.4-7.5 15.4-6.1 30.5-8.8 45.2-8.2 12.5.5 53.9 4.7 60 35.1 2.9 15.1 2.1 28.2-2.6 38.7zm-33-25.6c-5.3 1.6-10.6 3.2-15.8 4.8-9.8 3-19.9 6.1-30.1 8.8-4 1.1-8.1 2.1-12.1 3.1-11.6 3-23.6 6-34.9 10.4-.6.2-1.2.4-1.8.4-2.2 0-3.9-1.6-4.4-4-.4-2.2.4-4.9 3.3-6 12.7-4.9 26.1-8.2 39-11.5 2.8-.7 5.5-1.4 8.3-2.1 10.2-2.6 20.3-5.7 30.1-8.8 5.2-1.6 10.4-3.2 15.7-4.8.5-.2 1-.2 1.5-.2 2.7 0 4.4 2.2 4.7 4.4.3 2.1-.6 4.7-3.5 5.5zm6.1 12.7c.5 2.2-.4 4.2-2.5 5.2-31.4 15.7-59.7 24.8-86.5 28.1h-.7c-2.4 0-4.2-1.8-4.4-4.3-.2-2.5 1.4-5.5 4.7-5.8 25-3 51.7-11.8 81.9-26.8 3.1-1.6 6.8.4 7.5 3.6zm-18.2-33.3c-25.8 14.1-56.1 19.5-84.9 23.9-.3 0-.6.1-.8.1-3.1 0-5.2-2.6-5.4-5.2-.2-2.5 1.4-4.3 3.8-4.7 29.5-4.4 57.9-9.5 82.2-22.8 3-1.6 6.6.2 7.4 3.4.6 2.1-.3 4.2-2.3 5.3z" /></svg>'

// TODO: Put some standard icon
let icon = collaboardIcon
let iconHover = collaboardIconHover
if (config.whiteboardProvider === 'collaboard') {
  icon = collaboardIcon
  iconHover = collaboardIconHover
} else if (config.whiteboardProvider === 'conceptboard') {
  icon = conceptboardIcon
  iconHover = conceptboardIconHover
}

let plugin: Plugin
let button: Button<'toolbar'>

const buttonConfig: RPCCallPayload<'ui:button:add'> = {
  position: 'toolbar',
  icon: {
    custom: {
      main: icon,
      hover: iconHover
    }
  },
  tooltip: 'Open whiteboard',
  roles: ['chair', 'guest']
}

const initializeButton = async (): Promise<void> => {
  plugin = getPlugin()
  button = await plugin.ui.addButton(buttonConfig)
  button.onClick.add(handleOnClick)
}

const setButtonLink = async (link: string): Promise<void> => {
  if (isSameDomain()) {
    if (getVersion() === '32') {
      // In previous version we cannot update the button, so we remove it and
      // add it again. As a drawback, its position can change.
      await button.remove()
      button = await plugin.ui.addButton(Object.assign(buttonConfig, getOpensPopUpParams(popUpIdButton)))
    } else {
      button.onClick.remove(handleOnClick)
      await button.update(Object.assign(buttonConfig, getOpensPopUpParams(popUpIdButton)))
    }
  }
}

const handleOnClick = async (): Promise<void> => {
  if (getPopUpLink() !== '') {
    closePopUp()
    openPopUp()
  } else {
    if (getUser().role === 'chair') {
      await showCreatePanel(handleOnCreateAccepted)
    } else {
      await showNoWhiteboardPanel()
    }
  }
}

const handleOnCreateAccepted = async (): Promise<void> => {
  const ws = getWebSocket()
  if (ws.readyState === ws.CLOSED) {
    await showErrorPanel('Cannot communicate with the server to create the whiteboard.')
  } else {
    let request = { type: 'create' }
    if (config.whiteboardProvider != null) {
      request = Object.assign(request, { body: config.whiteboardProvider })
    }
    ws.send(JSON.stringify(request))
  }
}

export {
  initializeButton,
  setButtonLink
}
